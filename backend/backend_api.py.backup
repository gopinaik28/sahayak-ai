from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from crewai import Agent, Task, Crew, Process
import json
import os
import warnings
from rag.rag_engine import RAGEngine

warnings.filterwarnings('ignore')

# Configure Ollama
os.environ["OPENAI_API_BASE"] = "http://localhost:11434/v1"
os.environ["OPENAI_MODEL_NAME"] = "llama3.2"
os.environ["OPENAI_API_KEY"] = "ollama"

app = FastAPI(title="Health Insurance Recommendation API")

# CORS configuration
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000", "http://localhost:3001"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Initialize RAG Engine
print("ðŸš€ Initializing RAG Engine...")
rag_engine = RAGEngine()
print("âœ… RAG Engine ready!")

# Load valid insurer names for validation
with open('data/indian_health_insurance_data.json', 'r') as f:
    insurance_data = json.load(f)

VALID_INSURERS = set()
VALID_PLANS = set()
for insurer in insurance_data['insurers']:
    VALID_INSURERS.add(insurer['insurer_name'])
    for plan in insurer['plans']:
        VALID_PLANS.add(plan['plan_name'])

print(f"âœ… Loaded {len(VALID_INSURERS)} valid insurers:")
for insurer in VALID_INSURERS:
    print(f"   - {insurer}")

print(f"âœ… Loaded {len(VALID_PLANS)} valid plans")


def validate_response(response_text: str) -> tuple[bool, list[str]]:
    """
    Validate AI response to check for hallucinations
    
    Returns:
        (is_valid, errors)
    """
    errors = []
    
    # Check for invalid insurer names
    response_lower = response_text.lower()
    
    # Known hallucination patterns
    invalid_insurers = [
        "future generali",
        "bajaj allianz",
        "icici direct",
        "supersaver",
        "reliance",
        "tata aig",
        "max life"
    ]
    
    for invalid in invalid_insurers:
        if invalid in response_lower:
            errors.append(f"HALLUCINATION DETECTED: Found '{invalid}' - not in our database")
    
    # Check if response contains at least one valid insurer
    found_valid = False
    for valid_insurer in VALID_INSURERS:
        if valid_insurer.lower() in response_lower:
            found_valid = True
            break
    
    if not found_valid:
        errors.append("No valid insurance companies found in response")
    
    is_valid = len(errors) == 0
    return is_valid, errors
